<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="keyword" content="spring boot,actuator, shutdown,spring-security, csrf"/>
    <meta name="description" content="How to shutdown a spring boot application with the help of /actuator/shutdown。[spring boot 2.0.x]">
    <meta name="author" content="SuZhenYuan">
    <title>如何优雅地停止spring boot应用 -- SuZhenYuan's Blog</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/stylesheets/bootstrap.min.css" >
    <!-- Documentation extras -->
    <link href="https://cdn.bootcss.com/docsearch.js/2.4.1/docsearch.min.css" rel="stylesheet">
    <link href="/stylesheets/docs.min.css" rel="stylesheet">
    <link href="/stylesheets/jekyll.css" rel="stylesheet">
    <!--
        <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/stylesheets/github-dark.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print">
    -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74735331-10"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-74735331-10');
  </script>

  </head>

  <body>
    <section class="page-before-nav-section section-style"></section>
    <header id="nav-header" class="nav-header">
      <div class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar container nav-header-container">
        <a class="navbar-brand mr-0 mr-md-2" href="/" aria-label="Bootstrap"><svg class="d-block" width="36" height="36" viewBox="0 0 612 612" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>SuZhenYuan's Blog</title><path fill="currentColor" d="M510 8a94.3 94.3 0 0 1 94 94v408a94.3 94.3 0 0 1-94 94H102a94.3 94.3 0 0 1-94-94V102a94.3 94.3 0 0 1 94-94h408m0-8H102C45.9 0 0 45.9 0 102v408c0 56.1 45.9 102 102 102h408c56.1 0 102-45.9 102-102V102C612 45.9 566.1 0 510 0z"></path><path fill="currentColor" d="M196.77 471.5V154.43h124.15c54.27 0 91 31.64 91 79.1 0 33-24.17 63.72-54.71 69.21v1.76c43.07 5.49 70.75 35.82 70.75 78 0 55.81-40 89-107.45 89zm39.55-180.4h63.28c46.8 0 72.29-18.68 72.29-53 0-31.42-21.53-48.78-60-48.78h-75.57zm78.22 145.46c47.68 0 72.73-19.34 72.73-56s-25.93-55.37-76.46-55.37h-74.49v111.4z"></path></svg></a>    
        <div class="navbar-nav-scroll">
          <ul class="navbar-nav bd-navbar-nav flex-row">
            <li class="nav-item"><a class="nav-link " href="/" onclick="ga('send', 'event', 'Navbar', 'Blog links', 'Home');">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="/spring-boot" onclick="ga('send', 'event', 'Navbar', 'Blog links', 'Spring-Boot');">Spring-Boot</a></li>
            <li class="nav-item"><a class="nav-link" href="/spring-cloud" onclick="ga('send', 'event', 'Navbar', 'Blog links', 'Spring-cloud');">Spring-cloud</a></li>
            <li class="nav-item"><a class="nav-link" href="/archives" onclick="ga('send', 'event', 'Navbar', 'Blog links', 'Archives');">Archives</a></li>
            <li class="nav-item"><a class="nav-link" href="/about" onclick="ga('send', 'event', 'Navbar', 'Blog links', 'About');">About</a></li>
            <li class="nav-item"><a class="nav-link p-2" href="https://github.com/suzhenyuan" onclick="ga('send', 'event', 'Navbar', 'Github links', 'Home');" target="_blank" aria-label="GitHub"><svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64 0 0 114.61 0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34 0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49 0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75 0 0 21.49-6.88 70.4 26.24a242.65 242.65 0 0 1 128.18 0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69 0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41 0 34.22-.31 61.83-.31 70.23 0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37 0 256 0z" fill="currentColor" fill-rule="evenodd"></path></svg></a></li>
          </ul>
        </div>      
      </div>
    </header>
    <section class="page-title-section section-style">
        <div class="container">
        <div class="page-title">
            <h1 class="title-display">如何优雅地停止spring boot应用</h1>
            <small class="text-muted"></small>
          </div>
          </div>
    </section>
    <section class="page-main">

        <div class="container">
            <hr/>
              <article>
                <p>Spring Boot Actuator提供了一套完备的监控方案用来监控Spring Boot应用。本文将会根据在不同的场景下，采用不同的方式来关闭一个spring boot应用的。这些场景包括：</p>

<ul>
  <li>普通场景，没有启用任何安全设置</li>
  <li>启用了security配置，同时关闭了csrf</li>
  <li>启用了security配置，没有关闭csrf</li>
</ul>

<h2 id="pom配置">pom配置</h2>

<p>引入actuator和security相关的包，spring-boot的版本号为<code class="highlighter-rouge">2.0.4.RELEASE</code>，主要pom配置如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;!-- Import dependency management from Spring Boot --&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
            &lt;version&gt;2.0.4.RELEASE&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></div></div>

<h2 id="applicationproperties">application.properties</h2>
<p>在application.properties中，需要启用shutdown相关的endpoint：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>management.endpoint.shutdown.enabled=true
#注，此处只是配置了shutdown，如果需要启用其他endpoints，在shutdown后面添加即可，也可以直接用*号，启用所有的endpoints
management.endpoints.web.exposure.include= shutdown
</code></pre></div></div>

<h2 id="关闭脚本">关闭脚本</h2>

<p>假设应用运行地址是<code class="highlighter-rouge">http://localhost:8080</code></p>

<ul>
  <li>
    <p>在没有做其他配置的情况下，直接执行以下命令即可。</p>

    <p>curl -X POST http://localhost:8080/actuator/shutdown</p>
  </li>
  <li>
    <p>复杂一点的情况，如果需要启用安全设置,同时关闭了csrf，</p>

    <p>application.properties中增加以下安全设置：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  spring.security.user.name=user
  spring.security.user.password=password
</code></pre></div>    </div>

    <p>关闭csrf的configuration如下：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  import org.springframework.context.annotation.Configuration;
  import org.springframework.security.config.annotation.web.builders.HttpSecurity;
  import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

  @Configuration
  public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter {
      @Override
      protected void configure(HttpSecurity http) throws Exception {
          http.csrf().disable();
          super.configure(http);
      }
  }
</code></pre></div>    </div>

    <p>则，对应的命令为：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  curl -X POST http://user:password@localhost:8080/actuator/shutdown
</code></pre></div>    </div>
  </li>
  <li>
    <p>更复杂的情况，启用了安全设置，而没有关闭csrf，操作则会稍微复杂一点。思路如下：</p>
    <ul>
      <li>先从登录页获取当前csrf值</li>
      <li>登录</li>
      <li>再从登录页面获取一次csrf</li>
      <li>调用关闭url</li>
      <li>注意事项：使用curl时，必须带上前一个请求的cookie，并保存响应后的cookie</li>
    </ul>

    <p>具体脚本如下：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  #/bin/bash
  #description: shutdown a spring boot application with the protection of spring security without csrf disable
  #1、get csrf token from login page
  #2、login
  #3、get csrf token from login page
  #4、post to /actuator/shutdown

  url_of_login="http://localhost:8080/login"
  url_of_shutdown="http://localhost:8080/actuator/shutdown"
  fcookie=cookie.txt
  config_username=config_user
  config_password=config_password

  #get csrf from login page, save cookie to cookie.txt
  csrf=`curl ${url_of_login} -c ${fcookie} | grep "csrf" | sed 's/\(.*\)value\="\([^""]*\)"\(.*\)/\2/g'`
  echo 'csrf: ' ${csrf}
  #login
  curl -X POST ${url_of_login} -b ${fcookie} -c ${fcookie} -d "username=${config_username}&amp;password=${config_password}&amp;submit=Login&amp;_csrf=${csrf}"
  #get csrf from login page
  csrf=`curl ${url_of_login} -b ${fcookie} -c ${fcookie} | grep "csrf" | sed 's/\(.*\)value\="\([^""]*\)"\(.*\)/\2/g'`
  #post to /actuator/shutdown
  result=`curl -X POST -b ${fcookie} -H "X-CSRF-TOKEN: ${csrf}" ${url_of_shutdown}`

  if [ "$result" = '{"message":"Shutting down, bye..."}' ]; then
      echo -e "\033[49;31;1;5m application shutdown...\033[0m"
  fi
</code></pre></div>    </div>
  </li>
</ul>


              </article>
               <div id="disqus_thread"></div>
              <script>
              
              /**
              *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
              *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
              /*
              var disqus_config = function () {
              this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
              this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
              };
              */
              (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://blog-19881101-com.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
              })();
              </script>
              <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              
          </div>

    </section>
    <footer></footer>
    

    
    <script src="/javascripts/jquery-slim.min.js"></script>
    <script>window.jQuery || document.write('<script src="/javascripts/jquery-slim.min.js"><\/script>')</script>
    <script src="/javascripts/popper.min.js"></script>
    <script src="/javascripts/bootstrap.min.js"></script>
    <script src="/javascripts/stickUp.min.js"></script>
    <script type="text/javascript">
      //initiating jQuery
      /*
      jQuery(function($) {
        $(document).ready( function() {
          //enabling stickUp on the '.navbar-wrapper' class
          $('#nav-header').stickUp();
        });
      });
      */
    </script>
  </body>
</html>
